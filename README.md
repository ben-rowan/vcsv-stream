# vcsv://stream

A virtual CSV stream for creating unit / integration test fixtures.

## Install

```bash
composer require --dev ben-rowan/vcsv-stream
```

## Modes

You can generate CSV fixtures in two modes with vcsv://stream, online and offline.

### Online

You can use vcsv://stream as a direct replacement for your standard file stream. In this mode
vcsv://stream will dynamically generate fake CSV data based on the provided configuration.

pros:
* Fast test development / feedback loop.
* Each test run get's a different set of valid data. This means you have the chance to catch
  unexpected bugs in your code.
  
cons:
* Higher CPU and memory utilisation when generating large files (I'll see if I can reduce this!)

### Offline

You can also use vcsv://stream to generate a CSV fixture on disk. You can then use this later in
your test.

pros:
* Fast test execution with reduced CPU and memory load.

cons:
* Slower test development / feedback loop.
* Each test run get's the same data. This reduces the scope of your testing.

## Usage

### Online

The first step is to call vcsv://streams setup method in your test. This initialises and
registers the stream:

```php
/**
 * @throws VCsvStreamException
 */
public function setUp()
{
    VCsvStream::setup();
}
```

Next you load your configuration (see [here]() for config docs):

```php
/**
 * @test
 *
 * @throws ValidationException
 * @throws ParserException
 */
public function iCanTestSomething(): void
{
    VCsvStream::loadConfig('path/to/config.yaml');

    // ...
}
```

Finally you can use the stream as you would any other file stream:

```php
/**
 * @test
 *
 * @throws ValidationException
 * @throws ParserException
 */
public function iCanTestSomething(): void
{
    VCsvStream::loadConfig('path/to/config.yaml');

    $vCsv = new SplFileObject('vcsv://fixture.csv');

    // ...
}
```

### Offline

The provided `generate:csv` command makes this easy:

```bash
vendor/bin/vcsv generate:csv path/to/config.yaml
```

This will output a CSV file to `stdout` so you can easily see what's being generated. Once you're
happy you can dump this to disk:

```bash
vendor/bin/vcsv generate:csv path/to/config.yaml > some_fixture.csv
```

## Configuration

vcsv://stream uses yaml configuration file to define your CSV fixtures. This has many benifits
over simply creating CSV files and adding them to source control:

* You're defining the _rules_ for what get's generated. This means you know you have 100 rows
  of this type of data followed by 100 rows of another. If you just have the CSV then you have to
  guess this or get the information from a separate set of documentation.
* You can add comments. This means you can describe the choices made for the fixture in detail
  at the top as well as commenting choices made throughout the file. This is a big help.
* You can easily edit the CSV from you're IDE / text editor. This reduces the overhead of making
  changes as you develop your test. (This is particularly true of the online mode).
  
### Example

Here's a complete example of some vcsv://stream configuration. I'll go through each section
below:

```yaml
# This CSV is used to test for X, Y and Z

header:
  include: true
  columns:
    "Column One":
      type: value
      value: 1
    "Column Two":
      type: faker
      formatter: randomNumber
      unique: true
    "Column Three":
      type: text
records:
  "Record One":
    count: 10
    columns:
      "Column Two":
        type: value
        value: 2
      "Column Three":
        type: faker
        formatter: randomNumber
        unique: false
  # This record is important for some reason
  "Record Two":
    count: 100  # This is why we chose 10
    columns:
      "Column Two":
        type: value
        value: 3
      "Column Three":
        type: faker
        formatter: text
        unique: false
  "Record Three":
    count: 1000
    columns:
      "Column Two":
        type: value
        value: 4
      "Column Three":
        type: faker
        formatter: ipv4
```

### Header

#### `include`

#### `columns`

##### `value` Columns

##### `faker` Columns

##### `text` Columns

### Records

#### Name

#### `count`

#### `columns`








#### Data Generators

##### Value

This type of column will always contain the value passed for `$value`.

`addValueColumn(string $name, $value)`

* `$name` - The name for this column
* `$value` - The value to be used for this column

##### Faker

This type of column will contain a random value generated by the
[Faker](https://github.com/fzaninotto/Faker) library.

`addFakerColumn(string $name, string $formatter, bool $isUnique = false)`

* `$name` - The name for this column
* `$formatter` - One of the [Faker](https://github.com/fzaninotto/Faker) libraries [formatters](https://github.com/fzaninotto/Faker#formatters)
* `$isUnique` - When set to `true` no 2 rows will have the same value for this column

##### Column

This type of column will contain a random `text` value generated by the
[Faker](https://github.com/fzaninotto/Faker) library.

`addColumn(string $name)`

* `$name` - The name for this column