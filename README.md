# vcsv://stream

A virtual CSV stream for creating unit / integration test fixtures.

## Install

```bash
composer require --dev ben-rowan/vcsv-stream
```

## Modes

You can generate CSV fixtures in two modes with vcsv://stream, online and offline:

### Online

You can use vcsv://stream as a direct replacement for your standard file stream. In this mode
vcsv://stream will dynamically generate fake CSV data based on the provided configuration.

pros:
* Fast test development / feedback loop.
* Each test run get's a different set of valid data. This means you have the chance to catch
  unexpected bugs in your code.
  
cons:
* Higher CPU and memory utilisation when generating large files (I'll see if I can reduce this!)

### Offline

You can also use vcsv://stream to generate a CSV fixture on disk. You can then use this later in
your test.

pros:
* Fast test execution with reduced CPU and memory load.

cons:
* Slower test development / feedback loop.
* Each test run get's the same data reducing the scope of your testing.

## Usage

### Online

The first step is to call vcsv://streams setup method in your test. This initialises and
registers the stream:

```php
/**
 * @throws VCsvStreamException
 */
public function setUp()
{
    VCsvStream::setup();
}
```

Next you load your configuration (see [here]() for config docs):

```php
/**
 * @test
 *
 * @throws ValidationException
 * @throws ParserException
 */
public function iCanTestSomething(): void
{
    VCsvStream::loadConfig('path/to/config.yaml');

    // ...
}
```

And finally you can use the stream as you would any standard file stream:

```php
/**
 * @test
 *
 * @throws ValidationException
 * @throws ParserException
 */
public function iCanTestSomething(): void
{
    VCsvStream::loadConfig('path/to/config.yaml');

    $vCsv = new SplFileObject('vcsv://fixture.csv');

    // ...
}
```

### Offline

vcsv://stream provides a command to make this simple:

```bash
vendor/bin/vcsv generate:csv path/to/config.yaml
```

This will output a CSV to `stdout` so you can easily see what's being generated. Once you're
happy you can dump this to a file:

```bash
vendor/bin/vcsv generate:csv path/to/config.yaml > some_fixture.csv
```








## Configuration


---- benefits of defining fixtures in yaml over as CSVs ----




### Header

Now that we've initialised the stream it's time to set up our CSVs header. We have 2 options here:

* `Header` - The header will be included in the stream
* `NoHeader`. The header won't be included in the stream

Both are configured in the same way so we'll stick with `Header` for the rest of this section.

```php
$header = new Header();

$header
    ->addValueColumn(self::HEADER_1, 1)
    ->addFakerColumn(self::HEADER_2, 'randomNumber', true)
    ->addColumn(self::HEADER_3);

VCsvStream::setHeader($header);
```

We're doing 3 things here:

* Telling CSV stream how many columns we want
* Telling CSV stream what the names of the columns should be (even if we're using `NoHeader`)
* Setting the default data generator for each column

#### Data Generators

##### Value

This type of column will always contain the value passed for `$value`.

`addValueColumn(string $name, $value)`

* `$name` - The name for this column
* `$value` - The value to be used for this column

##### Faker

This type of column will contain a random value generated by the
[Faker](https://github.com/fzaninotto/Faker) library.

`addFakerColumn(string $name, string $formatter, bool $isUnique = false)`

* `$name` - The name for this column
* `$formatter` - One of the [Faker](https://github.com/fzaninotto/Faker) libraries [formatters](https://github.com/fzaninotto/Faker#formatters)
* `$isUnique` - When set to `true` no 2 rows will have the same value for this column

##### Column

This type of column will contain a random `text` value generated by the
[Faker](https://github.com/fzaninotto/Faker) library.

`addColumn(string $name)`

* `$name` - The name for this column

### Record

Finally we add our CSV records (rows). We add these in chunks.

```php
$records = [];

$records[] = (new Record(10))
    ->addValueColumn(self::HEADER_2, 2)
    ->addFakerColumn(self::HEADER_3, 'randomNumber', false);

$records[] = (new Record(100))
    ->addValueColumn(self::HEADER_2, 3)
    ->addFakerColumn(self::HEADER_3, 'text', false);

$records[] = (new Record(1000))
    ->addValueColumn(self::HEADER_2, 4)
    ->addFakerColumn(self::HEADER_3, 'ipv4', false);

VCsvStream::addRecords($records);
```

The above would give us 10 of the first record type followed by 100 of the second and 1000 of
the third. The data generators added here take precedence over the default header data generators.
This means that we only need to configure the columns that we want to be different and don't need
to worry about the others (notice no config for `self::HEADER_1` above).

### Read

Now that we've setup the stream we can use it like we would any normal CSV file.

```php
$vCsv = new SplFileObject('vcsv://fixture.csv');

while ($row = $vCsv->fgetcsv()) {
    // ...
}
```